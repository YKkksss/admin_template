# 后台管理系统开发文档

> 本文档详细规划了基于 **vue-vben-admin** 前端 + **FastAPI** 后端的后台管理系统模板开发方案。

---

## 目录

- [项目概述](#项目概述)
- [技术栈](#技术栈)
- [项目结构](#项目结构)
- [模块规划](#模块规划)
- [功能模块详细描述](#功能模块详细描述)
- [后端架构设计](#后端架构设计)
- [数据库设计](#数据库设计)
- [API 规范](#api-规范)
- [开发环境配置](#开发环境配置)
- [开发流程](#开发流程)
- [部署方案](#部署方案)

---

## 项目概述

### 项目目标

将当前项目开发为一个**标准化的后台管理系统模板**，集成常用的后台管理基础模块，为后续项目开发提供开箱即用的基础能力。

### 核心特性

- 🎨 **现代化前端**: 基于 vue-vben-admin 5.x，采用 Vue3 + Vite + TypeScript
- 🚀 **高性能后端**: 基于 FastAPI 的异步高性能 API 服务
- 🔐 **完善的权限系统**: RBAC 权限模型，支持动态路由和按钮级权限
- 🗄️ **灵活的数据库支持**: PostgreSQL / MySQL 可切换
- ⚡ **Redis 缓存**: 可选的缓存层，提升系统性能
- 📦 **现代化包管理**: 后端使用 uv，前端使用 pnpm
- 🔄 **最新依赖版本**: 前后端依赖包优先使用最新稳定版本

### 依赖版本策略

> **原则：优先使用最新版本，确保技术先进性和安全性**

| 优先级 | 策略 | 说明 |
|--------|------|------|
| 1️⃣ 首选 | **最新稳定版** | 优先使用依赖包的最新稳定版本（Latest Stable） |
| 2️⃣ 备选 | **兼容性版本** | 若最新版存在兼容性问题，选择经过社区验证的兼容版本 |
| 3️⃣ 锁定 | **版本锁定** | 使用 `uv.lock` / `pnpm-lock.yaml` 锁定版本，确保团队一致性 |

**注意事项**：
- 定期检查并更新依赖版本（建议每月一次）
- 更新前在开发环境充分测试
- 关注依赖的安全漏洞公告，及时修复
- 避免使用已停止维护的依赖包

---

## 技术栈

### 前端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Vue | 3.x | 渐进式 JavaScript 框架 |
| Vite | 6.x | 下一代前端构建工具 |
| TypeScript | 5.x | JavaScript 超集 |
| vue-vben-admin | 5.5.9 | 企业级中后台模板 |
| Ant Design Vue | 4.x | UI 组件库 |
| Pinia | 2.x | Vue 状态管理 |
| Vue Router | 4.x | 路由管理 |
| Axios | - | HTTP 客户端 |

### 后端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Python | 3.12+ | 编程语言 |
| FastAPI | 0.125+ | 高性能异步 Web 框架 |
| Tortoise ORM | 0.25+ | 异步 ORM 框架，原生支持 async/await |
| Aerich | 0.7+ | Tortoise ORM 数据库迁移工具 |
| Pydantic | 2.x | 数据验证 |
| uv | 0.5+ | Python 包管理器 |
| uvicorn | 0.30+ | ASGI 服务器 |

### 数据库与中间件

| 技术 | 说明 |
|------|------|
| PostgreSQL | 主数据库（推荐） |
| MySQL | 备选数据库 |
| Redis | 缓存 / Session / 消息队列 |

---

## 项目结构

```
admin_template/
├── backend/                    # 后端项目目录
│   ├── migrations/            # Aerich 数据库迁移文件
│   │   └── models/            # 迁移版本文件
│   ├── app/                   # 应用主目录
│   │   ├── api/               # API 路由
│   │   │   ├── v1/            # API v1 版本
│   │   │   │   ├── endpoints/ # 具体端点
│   │   │   │   └── deps.py    # 依赖注入
│   │   │   └── router.py      # 路由汇总
│   │   ├── core/              # 核心配置
│   │   │   ├── config.py      # 应用配置
│   │   │   ├── security.py    # 安全相关
│   │   │   └── database.py    # Tortoise ORM 配置
│   │   ├── models/            # Tortoise ORM 模型
│   │   │   ├── base.py        # 基础模型（公共字段 Mixin）
│   │   │   ├── user.py        # 用户模型
│   │   │   ├── role.py        # 角色模型
│   │   │   └── ...
│   │   ├── schemas/           # Pydantic 模式（请求/响应）
│   │   │   ├── user.py        # 用户模式
│   │   │   ├── role.py        # 角色模式
│   │   │   └── ...
│   │   ├── services/          # 业务逻辑层（异步服务）
│   │   │   ├── base.py        # 基础 CRUD 服务
│   │   │   ├── user.py        # 用户服务
│   │   │   ├── role.py        # 角色服务
│   │   │   └── ...
│   │   ├── utils/             # 工具函数
│   │   │   ├── cache.py       # Redis 缓存工具
│   │   │   ├── logger.py      # 日志工具
│   │   │   └── ...
│   │   └── main.py            # 应用入口
│   ├── tests/                 # 测试目录
│   │   ├── conftest.py        # 测试配置
│   │   ├── test_api/          # API 测试
│   │   └── test_services/     # 服务测试
│   ├── pyproject.toml         # 项目配置 (uv) + Aerich 迁移配置
│   └── .env.example           # 环境变量示例
├── docs/                      # 项目文档
│   ├── 开发文档.md            # 本文档
│   ├── API.md                 # API 文档
│   └── 部署指南.md            # 部署文档
└── web/                       # 前端项目 (vue-vben-admin)
    ├── apps/                  # 应用目录
    ├── packages/              # 公共包
    └── ...
```

---

## 模块规划

### 核心基础模块

#### 1. 系统管理模块 (System)

| 功能 | 说明 | 优先级 |
|------|------|--------|
| **用户管理** | 用户 CRUD、状态管理、密码重置 | P0 |
| **角色管理** | 角色 CRUD、权限分配 | P0 |
| **菜单管理** | 菜单 CRUD、动态路由生成 | P0 |
| **部门管理** | 组织架构、树形部门 | P1 |
| **岗位管理** | 岗位 CRUD | P2 |
| **字典管理** | 数据字典、枚举管理 | P1 |
| **参数配置** | 系统参数配置 | P2 |

#### 2. 权限认证模块 (Auth)

| 功能 | 说明 | 优先级 |
|------|------|--------|
| **登录认证** | 账号密码登录、验证码 | P0 |
| **JWT Token** | Token 生成、刷新、验证 | P0 |
| **权限验证** | 接口权限、按钮权限 | P0 |
| **多端登录** | 单点登录 / 多端登录控制 | P2 |
| **OAuth2.0** | 第三方登录（可选） | P3 |

#### 3. 日志监控模块 (Monitor)

| 功能 | 说明 | 优先级 |
|------|------|--------|
| **操作日志** | 记录用户操作行为 | P1 |
| **登录日志** | 记录登录信息、IP 等 | P1 |
| **API 日志** | 接口调用记录 | P2 |
| **系统监控** | 服务器状态监控 | P2 |
| **在线用户** | 在线用户管理 | P2 |

#### 4. 文件管理模块 (File)

| 功能 | 说明 | 优先级 |
|------|------|--------|
| **文件上传** | 单文件、多文件上传 | P1 |
| **文件存储** | 本地存储 / OSS 存储 | P1 |
| **文件管理** | 文件列表、删除 | P2 |

#### 5. 通知公告模块 (Notice)

| 功能 | 说明 | 优先级 |
|------|------|--------|
| **通知公告** | 发布系统通知 | P2 |
| **站内消息** | 用户间消息 | P3 |

---

### 模块优先级说明

- **P0**: 核心必须模块，第一阶段完成
- **P1**: 重要模块，第二阶段完成
- **P2**: 常用模块，第三阶段完成
- **P3**: 扩展模块，按需开发

---

## 功能模块详细描述

### 1. 首页（Dashboard）

**模块概述**：系统首页作为用户登录后的第一个页面，提供系统整体运行状态的概览和常用功能的快捷入口。

#### 功能要点

| 功能项 | 描述 |
|--------|------|
| **数据概览卡片** | 展示关键业务指标，如用户总数、今日登录数、待办事项数量、系统消息数量等 |
| **快捷操作入口** | 提供常用功能的快捷访问按钮，如新建用户、角色分配等 |
| **统计图表** | 以可视化图表展示用户活跃度趋势、登录统计、操作日志分布等 |
| **最近操作记录** | 显示当前用户的最近操作历史，便于快速回溯 |
| **待办事项列表** | 展示当前用户的待处理任务或审批流程 |
| **系统公告** | 滚动展示最新的系统通知和公告信息 |

#### 页面布局

- **顶部区域**：数据概览卡片组，采用响应式网格布局
- **中部区域**：左侧为统计图表（折线图/柱状图），右侧为快捷入口或待办事项
- **底部区域**：最近操作记录列表和系统公告轮播

#### 数据来源

- 实时从各业务模块获取统计数据
- 支持数据缓存，减少数据库压力
- 定时刷新或手动刷新机制

---

### 2. 用户管理（User Management）

**模块概述**：用户管理是系统的核心模块之一，负责系统用户的全生命周期管理，包括用户的创建、编辑、删除、状态控制及角色分配。

#### 功能要点

| 功能项 | 描述 |
|--------|------|
| **用户列表** | 分页展示所有用户，支持按用户名、手机号、状态、部门等条件筛选查询 |
| **新增用户** | 填写用户基本信息（用户名、密码、昵称、邮箱、手机号等），分配所属部门和角色 |
| **编辑用户** | 修改用户基本信息、部门归属、角色分配 |
| **删除用户** | 支持单个删除和批量删除，采用软删除方式保留历史数据 |
| **用户状态** | 启用/禁用用户账号，禁用后用户无法登录系统 |
| **重置密码** | 管理员可为用户重置密码，重置后通知用户修改 |
| **角色分配** | 为用户分配一个或多个角色，用户权限由角色决定 |
| **部门分配** | 将用户分配到指定部门，支持部门数据权限控制 |
| **导入导出** | 支持用户数据的 Excel 批量导入和导出 |

#### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 用户名 | 文本 | 是 | 登录账号，唯一标识，4-50字符 |
| 密码 | 文本 | 是 | 登录密码，加密存储，6-20字符 |
| 昵称 | 文本 | 否 | 用户显示名称 |
| 邮箱 | 文本 | 否 | 电子邮箱，格式校验 |
| 手机号 | 文本 | 否 | 手机号码，格式校验 |
| 性别 | 枚举 | 否 | 未知/男/女 |
| 头像 | 文件 | 否 | 用户头像图片 |
| 部门 | 选择 | 否 | 所属部门 |
| 角色 | 多选 | 是 | 用户角色，可多选 |
| 状态 | 开关 | 是 | 启用/禁用 |
| 备注 | 文本 | 否 | 用户备注信息 |

#### 业务规则

- 用户名全局唯一，创建后不可修改
- 超级管理员账号不可删除和禁用
- 删除用户前需确认，删除后用户相关会话失效
- 用户密码需满足复杂度要求（可配置）
- 角色变更后，下次登录生效新权限

---

### 3. 角色管理（Role Management）

**模块概述**：角色管理用于定义系统中的角色，并为角色分配菜单权限和操作权限。系统采用 RBAC（基于角色的访问控制）模型，用户通过角色获取相应的权限。

#### 功能要点

| 功能项 | 描述 |
|--------|------|
| **角色列表** | 展示所有角色，支持按名称、编码、状态筛选 |
| **新增角色** | 创建角色，设置角色名称、编码、排序、状态及备注 |
| **编辑角色** | 修改角色基本信息 |
| **删除角色** | 删除角色，需检查是否有用户关联 |
| **菜单分配** | 为角色分配可访问的菜单和按钮权限，采用树形复选框选择 |
| **数据权限** | 配置角色的数据权限范围（全部数据/本部门及以下/本部门/仅本人） |
| **角色状态** | 启用/禁用角色，禁用后关联用户失去该角色权限 |

#### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 角色名称 | 文本 | 是 | 角色显示名称，如"系统管理员" |
| 角色编码 | 文本 | 是 | 角色唯一标识，如"admin"，用于权限判断 |
| 排序 | 数字 | 否 | 角色显示排序，数字越小越靠前 |
| 状态 | 开关 | 是 | 启用/禁用 |
| 备注 | 文本 | 否 | 角色描述信息 |

#### 权限分配

- **菜单权限**：以树形结构展示所有菜单，勾选后角色可访问对应菜单页面
- **按钮权限**：菜单下的操作按钮（如新增、编辑、删除），勾选后角色可执行对应操作
- **接口权限**：后端接口权限码，与按钮权限对应

#### 数据权限范围

| 类型 | 说明 |
|------|------|
| 全部数据 | 可查看系统所有数据 |
| 本部门及以下 | 可查看本部门及下级部门的数据 |
| 本部门 | 仅可查看本部门数据 |
| 仅本人 | 仅可查看自己创建的数据 |
| 自定义 | 指定可访问的部门列表 |

---

### 4. 部门管理（Department Management）

**模块概述**：部门管理用于维护组织架构，支持多级部门的树形结构管理。部门与用户关联，可用于数据权限控制和组织人员归属。

#### 功能要点

| 功能项 | 描述 |
|--------|------|
| **部门树展示** | 以树形结构展示完整的组织架构，支持展开/折叠 |
| **新增部门** | 创建部门，选择上级部门，设置部门名称、负责人、联系方式等 |
| **编辑部门** | 修改部门信息，可调整上级部门 |
| **删除部门** | 删除部门，需检查是否有子部门或关联用户 |
| **部门排序** | 调整同级部门的显示顺序 |
| **部门状态** | 启用/禁用部门，禁用后该部门及下级部门用户数据权限受影响 |

#### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 部门名称 | 文本 | 是 | 部门显示名称 |
| 上级部门 | 选择 | 否 | 父级部门，顶级部门为空 |
| 负责人 | 文本 | 否 | 部门负责人姓名 |
| 联系电话 | 文本 | 否 | 部门联系电话 |
| 邮箱 | 文本 | 否 | 部门邮箱 |
| 排序 | 数字 | 否 | 同级部门排序 |
| 状态 | 开关 | 是 | 启用/禁用 |

#### 业务规则

- 部门名称在同级下唯一
- 删除部门前，需先移除或转移该部门下的所有用户
- 部门层级建议不超过5级
- 禁用上级部门时，下级部门状态跟随变更
- 部门调整会影响关联用户的数据权限范围

---

### 5. 菜单管理（Menu Management）

**模块概述**：菜单管理用于配置系统的导航菜单、页面路由及按钮权限。菜单数据用于动态生成前端路由和侧边栏导航。

#### 功能要点

| 功能项 | 描述 |
|--------|------|
| **菜单树展示** | 以树形表格展示所有菜单，包含目录、菜单、按钮三种类型 |
| **新增菜单** | 创建菜单项，配置路由信息、组件路径、图标、权限标识等 |
| **编辑菜单** | 修改菜单配置信息 |
| **删除菜单** | 删除菜单，需检查是否有子菜单 |
| **菜单排序** | 调整菜单的显示顺序 |
| **菜单状态** | 控制菜单是否在导航中显示 |

#### 菜单类型说明

| 类型 | 用途 | 说明 |
|------|------|------|
| **目录** | 一级菜单 | 用于菜单分组，本身无页面，包含子菜单 |
| **菜单** | 页面菜单 | 对应一个具体的页面路由 |
| **按钮** | 操作按钮 | 页面内的操作权限，如新增、编辑、删除按钮 |

#### 字段说明

| 字段 | 类型 | 适用类型 | 必填 | 说明 |
|------|------|----------|------|------|
| 上级菜单 | 选择 | 全部 | 否 | 父级菜单，顶级为空 |
| 菜单类型 | 单选 | 全部 | 是 | 目录/菜单/按钮 |
| 菜单名称 | 文本 | 全部 | 是 | 菜单显示名称 |
| 路由地址 | 文本 | 目录/菜单 | 是 | 前端路由 path |
| 组件路径 | 文本 | 菜单 | 是 | 前端组件路径 |
| 重定向 | 文本 | 目录 | 否 | 重定向地址 |
| 菜单图标 | 图标 | 目录/菜单 | 否 | 菜单前的图标 |
| 权限标识 | 文本 | 按钮 | 是 | 权限码，如 `system:user:add` |
| 排序 | 数字 | 全部 | 否 | 同级排序 |
| 是否显示 | 开关 | 目录/菜单 | 是 | 是否在导航栏显示 |
| 状态 | 开关 | 全部 | 是 | 启用/禁用 |

#### 权限标识命名规范

采用三段式命名：`模块:子模块:操作`

| 权限标识 | 说明 |
|----------|------|
| `system:user:list` | 用户列表查看权限 |
| `system:user:add` | 用户新增权限 |
| `system:user:edit` | 用户编辑权限 |
| `system:user:delete` | 用户删除权限 |
| `system:role:assign` | 角色分配权限 |

---

### 6. 消息通知（Message & Notification）

**模块概述**：消息通知模块提供系统内的消息传递能力，包括系统公告发布、站内消息推送、消息阅读状态管理等功能。

#### 功能要点

| 功能项 | 描述 |
|--------|------|
| **公告管理** | 发布、编辑、删除系统公告，设置公告类型、状态、有效期 |
| **公告列表** | 管理后台查看所有公告，支持筛选和分页 |
| **通知发送** | 向指定用户或全体用户发送站内通知 |
| **消息收件箱** | 用户查看收到的所有消息，区分已读和未读 |
| **消息详情** | 点击消息查看详情，自动标记为已读 |
| **批量操作** | 批量标记已读、批量删除消息 |
| **未读提醒** | 顶部导航栏显示未读消息数量，点击可快速查看 |

#### 公告类型

| 类型 | 说明 |
|------|------|
| 通知 | 一般性系统通知 |
| 公告 | 重要公告信息 |
| 警告 | 警告提示类消息 |

#### 消息状态

| 状态 | 说明 |
|------|------|
| 未读 | 消息未被查看 |
| 已读 | 消息已被查看 |
| 已删除 | 消息已被用户删除（软删除） |

#### 字段说明（公告）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 公告标题 | 文本 | 是 | 公告标题 |
| 公告类型 | 枚举 | 是 | 通知/公告/警告 |
| 公告内容 | 富文本 | 是 | 公告正文，支持富文本编辑 |
| 状态 | 开关 | 是 | 启用/关闭 |
| 发布时间 | 日期 | 否 | 定时发布时间 |
| 失效时间 | 日期 | 否 | 公告失效时间 |

#### 消息推送场景

- 用户账号状态变更通知
- 角色权限变更通知
- 密码即将过期提醒
- 系统维护公告
- 业务审批通知（扩展）

---

### 7. 权限管理（Permission Management）

**模块概述**：权限管理贯穿整个系统，控制用户对菜单、按钮、接口、数据的访问权限。系统采用 RBAC 权限模型，通过用户-角色-权限的关系实现灵活的权限控制。

#### 权限控制层级

| 层级 | 控制点 | 说明 |
|------|--------|------|
| **菜单权限** | 前端路由 | 控制用户可访问的页面，无权限菜单不显示 |
| **按钮权限** | 页面操作 | 控制页面内按钮的显示/隐藏，如编辑、删除按钮 |
| **接口权限** | 后端API | 控制用户可调用的后端接口，无权限返回403 |
| **数据权限** | 数据范围 | 控制用户可查看的数据范围，如只能查看本部门数据 |

#### 功能要点

| 功能项 | 描述 |
|--------|------|
| **权限码管理** | 维护系统所有权限标识码，与菜单按钮关联 |
| **权限分配** | 通过角色为用户分配权限，参见角色管理的菜单分配功能 |
| **权限查询** | 查看指定用户或角色拥有的所有权限 |
| **接口权限配置** | 配置后端 API 需要的权限码 |
| **数据权限规则** | 配置角色的数据权限规则 |

#### 权限验证流程

**前端权限验证**：
1. 用户登录后获取权限码列表
2. 路由守卫根据权限码过滤可访问路由
3. 页面渲染时根据权限码控制按钮显示
4. 无权限页面跳转到403页面

**后端权限验证**：
1. 请求携带 JWT Token
2. 解析 Token 获取用户信息
3. 查询用户角色及权限码
4. 校验接口所需权限码
5. 无权限返回403状态码

#### 权限缓存策略

- 用户登录时缓存权限信息到 Redis
- 权限变更时清除相关用户缓存
- 设置合理的缓存过期时间
- Token 刷新时更新权限缓存

---

### 8. 字典管理（Dictionary Management）

**模块概述**：字典管理用于维护系统中的各种枚举值和配置项，如性别、状态、类型等。通过字典管理可以在不修改代码的情况下，灵活调整这些选项值。

#### 功能要点

| 功能项 | 描述 |
|--------|------|
| **字典类型管理** | 管理字典的分类，如"性别"、"用户状态"等 |
| **字典数据管理** | 管理字典类型下的具体数据项 |
| **字典查询** | 根据字典类型编码查询字典数据列表 |
| **字典缓存** | 字典数据缓存，提升查询性能 |
| **缓存刷新** | 手动刷新字典缓存 |

#### 字典类型字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 字典名称 | 文本 | 是 | 字典的显示名称，如"用户性别" |
| 字典编码 | 文本 | 是 | 字典的唯一标识，如"sys_user_gender" |
| 状态 | 开关 | 是 | 启用/禁用 |
| 备注 | 文本 | 否 | 字典说明 |

#### 字典数据字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 字典标签 | 文本 | 是 | 显示值，如"男"、"女" |
| 字典值 | 文本 | 是 | 实际存储值，如"1"、"2" |
| 排序 | 数字 | 否 | 显示顺序 |
| 状态 | 开关 | 是 | 启用/禁用 |
| 样式 | 枚举 | 否 | 标签样式，如颜色标记 |
| 备注 | 文本 | 否 | 数据说明 |

#### 内置字典示例

| 字典编码 | 字典名称 | 数据项 |
|----------|----------|--------|
| `sys_user_gender` | 用户性别 | 未知(0)、男(1)、女(2) |
| `sys_common_status` | 通用状态 | 禁用(0)、启用(1) |
| `sys_yes_no` | 是否选项 | 否(0)、是(1) |
| `sys_notice_type` | 通知类型 | 通知(1)、公告(2)、警告(3) |
| `sys_oper_type` | 操作类型 | 查询(1)、新增(2)、修改(3)、删除(4) |

#### 使用方式

**前端使用**：
- 页面加载时从接口获取所需字典数据
- 下拉选择框、单选框等组件绑定字典数据
- 列表中根据字典值显示对应标签

**后端使用**：
- 数据校验时验证值是否在字典范围内
- 返回数据时可转换为字典标签
- 导出时使用字典标签替代编码值

---

## 后端架构设计

### 分层架构

```
┌─────────────────────────────────────────┐
│              API Layer (Router)          │  ← 路由层：接收请求，参数验证
├─────────────────────────────────────────┤
│            Service Layer                 │  ← 服务层：业务逻辑
├─────────────────────────────────────────┤
│           Repository Layer               │  ← 数据访问层（可选）
├─────────────────────────────────────────┤
│              Model Layer                 │  ← 模型层：ORM 模型
├─────────────────────────────────────────┤
│              Database                    │  ← 数据库
└─────────────────────────────────────────┘
```

### 核心设计原则

1. **依赖注入**: 使用 FastAPI 的 `Depends` 实现依赖注入
2. **全异步架构**: Tortoise ORM 原生支持 async/await，所有数据库操作均为异步
3. **统一响应**: 统一的 API 响应格式
4. **异常处理**: 全局异常处理器
5. **日志追踪**: 完善的日志记录
6. **高性能**: 异步 IO 充分利用 Python asyncio 特性，提升并发处理能力

### 统一响应格式

```python
{
    "code": 200,          # 状态码
    "message": "success", # 消息
    "data": { ... },      # 数据
    "timestamp": 1234567  # 时间戳
}
```

### 目录结构详解

```python
app/
├── api/
│   └── v1/
│       ├── endpoints/
│       │   ├── auth.py       # 认证相关接口
│       │   ├── users.py      # 用户管理接口
│       │   ├── roles.py      # 角色管理接口
│       │   ├── menus.py      # 菜单管理接口
│       │   ├── depts.py      # 部门管理接口
│       │   └── ...
│       ├── deps.py           # 公共依赖
│       └── router.py         # 路由汇总
├── core/
│   ├── config.py             # 配置类
│   ├── security.py           # JWT、密码加密
│   ├── database.py           # 数据库连接
│   └── redis.py              # Redis 连接
├── models/
│   ├── base.py               # 基础模型（包含公共字段）
│   ├── user.py               # 用户模型
│   ├── role.py               # 角色模型
│   ├── menu.py               # 菜单模型
│   └── ...
├── schemas/
│   ├── base.py               # 基础 Schema
│   ├── user.py               # 用户 Schema
│   ├── role.py               # 角色 Schema
│   └── ...
├── services/
│   ├── base.py               # 基础服务（CRUD）
│   ├── user.py               # 用户服务
│   ├── role.py               # 角色服务
│   └── ...
└── utils/
    ├── cache.py              # 缓存工具
    ├── logger.py             # 日志配置
    ├── pagination.py         # 分页工具
    └── response.py           # 响应工具
```

---

## 数据库设计

### 数据库配置切换

系统支持 PostgreSQL 和 MySQL 切换，通过环境变量配置。Tortoise ORM 使用不同的数据库 URL 格式：

```env
# PostgreSQL (推荐，使用 asyncpg 驱动)
DATABASE_URL=postgres://user:password@localhost:5432/admin_db

# MySQL (使用 aiomysql 驱动)
DATABASE_URL=mysql://user:password@localhost:3306/admin_db
```

### Tortoise ORM 配置示例

```python
# app/core/database.py
TORTOISE_ORM = {
    "connections": {
        "default": os.getenv("DATABASE_URL")
    },
    "apps": {
        "models": {
            "models": ["app.models", "aerich.models"],
            "default_connection": "default",
        },
    },
    "use_tz": True,
    "timezone": "Asia/Shanghai",
}
```

### 异步数据库操作优势

| 特性 | 说明 |
|------|------|
| **原生异步** | Tortoise ORM 从底层设计就支持 async/await，无需额外适配 |
| **高并发** | 异步 IO 可在等待数据库响应时处理其他请求 |
| **连接池** | 内置异步连接池管理，自动复用连接 |
| **事务支持** | 支持异步事务 `async with in_transaction()` |
| **关联加载** | 支持 `prefetch_related` 和 `select_related` 优化查询 |

### 核心数据表设计

#### 用户表 (sys_user)

```sql
CREATE TABLE sys_user (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(128) NOT NULL,
    nickname VARCHAR(50),
    email VARCHAR(100),
    phone VARCHAR(20),
    avatar VARCHAR(255),
    gender SMALLINT DEFAULT 0,          -- 0:未知 1:男 2:女
    status SMALLINT DEFAULT 1,          -- 0:禁用 1:启用
    dept_id BIGINT,                     -- 部门ID
    remark VARCHAR(500),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    created_by BIGINT,
    updated_by BIGINT,
    deleted_at TIMESTAMP                -- 软删除
);
```

#### 角色表 (sys_role)

```sql
CREATE TABLE sys_role (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    code VARCHAR(50) UNIQUE NOT NULL,   -- 角色编码
    sort INT DEFAULT 0,
    status SMALLINT DEFAULT 1,
    remark VARCHAR(500),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP
);
```

#### 菜单表 (sys_menu)

```sql
CREATE TABLE sys_menu (
    id BIGSERIAL PRIMARY KEY,
    parent_id BIGINT DEFAULT 0,         -- 父菜单ID
    name VARCHAR(50) NOT NULL,          -- 菜单名称
    path VARCHAR(200),                  -- 路由路径
    component VARCHAR(200),             -- 组件路径
    redirect VARCHAR(200),              -- 重定向
    icon VARCHAR(50),                   -- 图标
    title VARCHAR(50),                  -- 菜单标题
    type SMALLINT DEFAULT 1,            -- 1:目录 2:菜单 3:按钮
    permission VARCHAR(100),            -- 权限标识
    sort INT DEFAULT 0,
    visible BOOLEAN DEFAULT TRUE,       -- 是否显示
    status SMALLINT DEFAULT 1,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 用户角色关联表 (sys_user_role)

```sql
CREATE TABLE sys_user_role (
    user_id BIGINT NOT NULL,
    role_id BIGINT NOT NULL,
    PRIMARY KEY (user_id, role_id)
);
```

#### 角色菜单关联表 (sys_role_menu)

```sql
CREATE TABLE sys_role_menu (
    role_id BIGINT NOT NULL,
    menu_id BIGINT NOT NULL,
    PRIMARY KEY (role_id, menu_id)
);
```

#### 部门表 (sys_dept)

```sql
CREATE TABLE sys_dept (
    id BIGSERIAL PRIMARY KEY,
    parent_id BIGINT DEFAULT 0,
    name VARCHAR(50) NOT NULL,
    sort INT DEFAULT 0,
    leader VARCHAR(50),                 -- 负责人
    phone VARCHAR(20),
    email VARCHAR(100),
    status SMALLINT DEFAULT 1,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP
);
```

#### 字典类型表 (sys_dict_type)

```sql
CREATE TABLE sys_dict_type (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,         -- 字典名称
    code VARCHAR(100) UNIQUE NOT NULL,  -- 字典编码
    status SMALLINT DEFAULT 1,
    remark VARCHAR(500),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 字典数据表 (sys_dict_data)

```sql
CREATE TABLE sys_dict_data (
    id BIGSERIAL PRIMARY KEY,
    type_code VARCHAR(100) NOT NULL,    -- 字典类型编码
    label VARCHAR(100) NOT NULL,        -- 字典标签
    value VARCHAR(100) NOT NULL,        -- 字典值
    sort INT DEFAULT 0,
    status SMALLINT DEFAULT 1,
    remark VARCHAR(500),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 操作日志表 (sys_operation_log)

```sql
CREATE TABLE sys_operation_log (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT,
    username VARCHAR(50),
    module VARCHAR(50),                 -- 操作模块
    action VARCHAR(50),                 -- 操作类型
    method VARCHAR(10),                 -- 请求方法
    url VARCHAR(500),                   -- 请求URL
    ip VARCHAR(50),                     -- IP地址
    request_data TEXT,                  -- 请求数据
    response_data TEXT,                 -- 响应数据
    status SMALLINT,                    -- 状态
    duration INT,                       -- 耗时(ms)
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 登录日志表 (sys_login_log)

```sql
CREATE TABLE sys_login_log (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT,
    username VARCHAR(50),
    ip VARCHAR(50),
    location VARCHAR(100),              -- 登录地点
    browser VARCHAR(50),                -- 浏览器
    os VARCHAR(50),                     -- 操作系统
    status SMALLINT,                    -- 0:失败 1:成功
    message VARCHAR(200),               -- 消息
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## API 规范

### RESTful API 设计

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/v1/users | 获取用户列表 |
| GET | /api/v1/users/{id} | 获取单个用户 |
| POST | /api/v1/users | 创建用户 |
| PUT | /api/v1/users/{id} | 更新用户 |
| DELETE | /api/v1/users/{id} | 删除用户 |

### 核心 API 列表

#### 认证接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/auth/login` | POST | 用户登录 |
| `/api/v1/auth/logout` | POST | 用户登出 |
| `/api/v1/auth/refresh` | POST | 刷新 Token |
| `/api/v1/auth/userinfo` | GET | 获取用户信息 |
| `/api/v1/auth/codes` | GET | 获取权限码 |
| `/api/v1/auth/menus` | GET | 获取用户菜单 |

#### 用户管理接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/users` | GET | 用户列表 |
| `/api/v1/users` | POST | 创建用户 |
| `/api/v1/users/{id}` | GET | 用户详情 |
| `/api/v1/users/{id}` | PUT | 更新用户 |
| `/api/v1/users/{id}` | DELETE | 删除用户 |
| `/api/v1/users/{id}/status` | PUT | 修改状态 |
| `/api/v1/users/{id}/password` | PUT | 重置密码 |

#### 角色管理接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/roles` | GET | 角色列表 |
| `/api/v1/roles` | POST | 创建角色 |
| `/api/v1/roles/{id}` | GET | 角色详情 |
| `/api/v1/roles/{id}` | PUT | 更新角色 |
| `/api/v1/roles/{id}` | DELETE | 删除角色 |
| `/api/v1/roles/{id}/menus` | PUT | 分配菜单 |

#### 菜单管理接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/menus` | GET | 菜单列表/树 |
| `/api/v1/menus` | POST | 创建菜单 |
| `/api/v1/menus/{id}` | GET | 菜单详情 |
| `/api/v1/menus/{id}` | PUT | 更新菜单 |
| `/api/v1/menus/{id}` | DELETE | 删除菜单 |

### 请求/响应示例

#### 登录请求

```json
POST /api/v1/auth/login
{
    "username": "admin",
    "password": "123456"
}
```

#### 登录响应

```json
{
    "code": 200,
    "message": "登录成功",
    "data": {
        "accessToken": "eyJhbGciOiJIUzI1NiIs...",
        "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
        "expiresIn": 7200
    }
}
```

#### 分页查询请求

```
GET /api/v1/users?page=1&pageSize=10&username=admin&status=1
```

#### 分页响应

```json
{
    "code": 200,
    "message": "success",
    "data": {
        "list": [...],
        "total": 100,
        "page": 1,
        "pageSize": 10
    }
}
```

---

## 开发环境配置

### 环境要求

- **Python**: 3.12+
- **Node.js**: 20.12.0+
- **pnpm**: 10.0.0+
- **uv**: 0.5+
- **PostgreSQL**: 15+ 或 **MySQL**: 8.0+
- **Redis**: 7.0+ (可选)

### 后端环境配置

#### 1. 安装 uv

```bash
# Windows (PowerShell)
irm https://astral.sh/uv/install.ps1 | iex

# 或使用 pip
pip install uv
```

#### 2. 创建项目

```bash
cd backend

# 初始化项目
uv init

# 安装核心依赖
uv add fastapi uvicorn[standard] pydantic pydantic-settings

# 安装 Tortoise ORM 和 Aerich（数据库迁移）
uv add tortoise-orm aerich

# 安装数据库驱动（根据需要选择）
uv add asyncpg  # PostgreSQL（推荐）
# 或 uv add aiomysql  # MySQL

# 安装其他依赖
uv add python-jose[cryptography] passlib[bcrypt]
uv add redis python-multipart aiofiles

# 开发依赖
uv add --dev pytest pytest-asyncio httpx ruff mypy
```

#### 3. 数据库迁移（Aerich）

```bash
# 初始化 Aerich（首次使用）
uv run aerich init -t app.core.database.TORTOISE_ORM

# 初始化数据库（创建迁移表）
uv run aerich init-db

# 创建迁移文件
uv run aerich migrate --name "add_new_field"

# 执行迁移
uv run aerich upgrade

# 回滚迁移
uv run aerich downgrade
```

#### 4. 环境变量配置

创建 `.env` 文件：

```env
# 应用配置
APP_NAME=Admin Template API
APP_VERSION=1.0.0
DEBUG=true
SECRET_KEY=your-secret-key-change-in-production

# 数据库配置（Tortoise ORM 格式）
DATABASE_URL=postgres://postgres:password@localhost:5432/admin_db
# DATABASE_URL=mysql://root:password@localhost:3306/admin_db

# Redis 配置 (可选)
REDIS_URL=redis://localhost:6379/0

# JWT 配置
JWT_SECRET_KEY=your-jwt-secret-key
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=120
JWT_REFRESH_TOKEN_EXPIRE_DAYS=7

# CORS 配置
CORS_ORIGINS=["http://localhost:5173", "http://localhost:3000"]
```

#### 5. 启动后端服务

```bash
cd backend
uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 前端环境配置

#### 1. 安装依赖

```bash
cd web
npm i -g corepack
pnpm install
```

#### 2. 开发模式启动

```bash
# 使用 Ant Design Vue 版本
pnpm dev:antd
```

#### 3. 前端配置

修改 `apps/web-antd/.env.development`：

```env
# API 基础地址
VITE_GLOB_API_URL=http://localhost:8000/api/v1
```

---

## 开发流程

### 第一阶段：核心框架搭建

**时间预估: 1-2 周**

1. **后端项目初始化**
   - 创建项目结构
   - 配置 uv 和依赖
   - 配置数据库连接
   - 创建基础模型

2. **认证模块开发**
   - JWT Token 生成与验证
   - 登录/登出接口
   - 用户信息获取

3. **用户管理模块**
   - 用户 CRUD 接口
   - 密码加密与验证

4. **角色管理模块**
   - 角色 CRUD 接口
   - 用户角色关联

5. **菜单管理模块**
   - 菜单 CRUD 接口
   - 动态路由生成

### 第二阶段：功能完善

**时间预估: 1-2 周**

1. **部门管理模块**
2. **字典管理模块**
3. **操作日志模块**
4. **登录日志模块**
5. **前端适配与联调**

### 第三阶段：优化与扩展

**时间预估: 1 周**

1. **Redis 缓存集成**
2. **文件上传模块**
3. **系统监控模块**
4. **单元测试完善**
5. **文档完善**

---

## 部署方案

> 说明：当前阶段暂不使用 Docker 部署，以下内容已注释保留，后续需要时可取消注释。

<!--
### Docker 部署

#### docker-compose.yml

```yaml
version: '3.8'

services:
  # PostgreSQL 数据库
  postgres:
    image: postgres:15-alpine
    container_name: admin_postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: admin_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: admin_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # 后端服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: admin_backend
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:password@postgres:5432/admin_db
      - REDIS_URL=redis://redis:6379/0
    ports:
      - "8000:8000"
    depends_on:
      - postgres
      - redis

  # 前端服务
  frontend:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: admin_frontend
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  postgres_data:
  redis_data:
```

#### 后端 Dockerfile

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# 安装 uv
RUN pip install uv

# 复制依赖文件
COPY pyproject.toml uv.lock ./

# 安装依赖
RUN uv sync --frozen

# 复制源代码
COPY . .

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["uv", "run", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```
-->

---

## 开发要点与注意事项

### 安全性

1. **密码存储**: 使用 bcrypt 加密存储
2. **JWT 安全**: 使用强密钥，设置合理过期时间
3. **SQL 注入防护**: 使用 ORM 参数化查询
4. **XSS 防护**: 前端输入验证与过滤
5. **CORS 配置**: 仅允许可信域名

### 性能优化

1. **数据库索引**: 为常用查询字段建立索引
2. **缓存策略**: 使用 Redis 缓存热点数据
3. **分页查询**: 所有列表接口必须分页
4. **异步处理**: 充分利用 FastAPI 异步特性

### 代码规范

1. **类型注解**: 所有函数必须使用类型注解
2. **文档字符串**: 所有公开方法必须有 docstring
3. **代码格式化**: 使用 ruff 进行代码格式化
4. **命名规范**: 遵循 PEP8 命名规范

### 前后端对接

1. **API 文档**: 使用 FastAPI 自动生成的 Swagger 文档
2. **接口规范**: 严格遵循 RESTful 规范
3. **错误处理**: 统一的错误码和错误信息格式
4. **跨域配置**: 正确配置 CORS

---

## 参考资源

- [FastAPI 官方文档](https://fastapi.tiangolo.com/)
- [SQLAlchemy 2.0 文档](https://docs.sqlalchemy.org/)
- [vue-vben-admin 文档](https://doc.vben.pro/)
- [Pydantic V2 文档](https://docs.pydantic.dev/)
- [uv 包管理器文档](https://docs.astral.sh/uv/)

---

> 文档版本: 1.0.0  
> 最后更新: 2026-01-13
